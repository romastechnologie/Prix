{% extends 'base.html.twig' %}

{% block title %}New Conditionnement{% endblock %}
{% block pageActive %} Conditionnement {% endblock %}

{% block content %}

    <div class="row">
        <div class="col-6">
            <!--begin::List Widget 9-->
                <div class="card card-custom card-stretch gutter-b">
                    <!--begin::Header-->
                    <div class="card-header align-items-center border-0 mt-4">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="font-weight-bolder text-dark">Un nouveau conditonnement</span>
                            <span class="text-muted mt-3 font-weight-bold font-size-sm">SOMIMAS</span>
                        </h3>
                        <div class="card-toolbar">
                            <div class="dropdown dropdown-inline">
                                <a href="#" class="btn btn-clean btn-hover-light-primary btn-sm btn-icon" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="ki ki-bold-more-hor"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <!--end::Header-->
                    <!--begin::Body-->
                    <div class="card-body pt-4">
                        <!--begin::Timeline-->
                        <!--begin::Form-->
                        {{ form_start(form) }}
                           {{ include('conditionnement/_form.html.twig') }}
                            <div class="card-footer">
                                <button type="submit" id="soum" class="btn btn-primary mr-2">Enregistrer</button>
                                <button type="reset" id="reset" class="btn btn-secondary">Annulé</button>
                            </div>
                        {{ form_end(form) }}
                        <!--end::Form-->
                        <!--end::Timeline-->
                    </div>
                    <!--end: Card Body-->
                </div>
            <!--end: List Widget 9-->
        </div>
        <div class="col-6">
            <!--begin::List Widget 9-->
                <div class="card card-custom card-stretch gutter-b">
                    <!--begin::Header-->
                    <div class="card-header align-items-center border-0 mt-4">
                        <h3 class="card-title align-items-start flex-column">
                            <span class="font-weight-bolder text-dark">Liste des conditonnements</span>
                            <span class="text-muted mt-3 font-weight-bold font-size-sm">SOMIMAS</span>
                        </h3>
                        <div class="card-toolbar">
                            <div class="dropdown dropdown-inline">
                                <a href="#" class="btn btn-clean btn-hover-light-primary btn-sm btn-icon" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="ki ki-bold-more-hor"></i>
                                </a>

                            </div>
                        </div>
                    </div>
                    <!--end::Header-->
                    <!--begin::Body-->
                    <div class="card-body pt-4 ">
                        <!--begin: Datatable-->
                        <div class="dataTables_scrollBody">  
                            <table class="table table-separate table-head-custom table-checkable dataTable no-footer dtr-inline collapsed" id="test">
                                <thead>
                                <tr>
                                    <th>Id</th>
                                    <th class="text-center">Code</th>
                                    <th>Libelle</th>
                                    <th>Quantité</th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                            </table>
                        </div> 
                        <!--end: Datatable-->
                    </div>
                    <!--end: Card Body-->
                </div>
            <!--end: List Widget 9-->
        </div>
    </div>

    

{% endblock %}
{% block javascripts %}
{{ parent() }}
<script>
    function vidage(){
        $("#conditionnement_libelle").val("");
        $("#conditionnement_id").val("");
        $("#conditionnement_code").val("");
        $("#conditionnement_qte").val("");
        return true;
    }

    function recharge(){
            $('#test').dataTable().fnClearTable();
            $('#test').dataTable().fnDestroy();
            $('#test').DataTable({
                'ajax' : {  url:  '{{ path("conditionnement_liste") }}',
                        dataSrc: 'data',
                        complete:function(){
                                
                                $(".suppr").click(function(e) {
                                    let id = $(this).attr("data-id");
                                    console.log(id);
                                    Swal.fire({
                                        title: "Etes-vous sûr de vouloir supprimer cet enregistrement ?",
                                        text: "Cette action est irréversible" ,
                                        icon: "warning",
                                        showCancelButton: true,
                                        cancelButtonText: "Non",
                                        confirmButtonText: "Oui"
                                    }).then(function(result) {
                                        if (result.value) {
                                                $.ajax({
                                                    url: "{{path('app_conditionnement_delete')}}",
                                                    method: "POST",
                                                    data:{ id: JSON.stringify(id)},
                                                    dataType: "json"
                                                    })
                                                    .done(function( data ) {
                                                        if(data[0] == "Succes"){
                                                            recharge();
                                                            Swal.fire(
                                                                "Suppression effective",
                                                                "L'enregistrement a bien été supprimé. ",
                                                                "success"
                                                            );
                                                            vidage();
                                                        }else{
                                                            Swal.fire(
                                                                "Suppression effective",
                                                                data[1],
                                                                "error"
                                                            );
                                                            vidage();
                                                        }

                                                    })
                                            
                                            
                                        }
                                });

                         
                            })
                        }
                    },
                'columns' : [
                    {"data":"id"},
                    {"data":"code"},
                    {"data":"libelle"},
                    {"data":"qte"},
                    {"data":null }
                ],
                columnDefs: [
                {
                    targets: -1,
                    data: null,
                "render": function (data) {
                    let id1 = data.id;
                    let code = data.code;
                    let libel = data.libelle;
                    let qteC = data.qte;
                    $(".modif").click(function(){
                        vidage()
                        let id = $(this).attr("data-id");
                        let contenu = $(this).attr("data-libelle");
                        let codeAt = $(this).attr("data-code");
                        let qte = $(this).attr("data-qte");
                        $("#conditionnement_libelle").val(contenu);
                        $("#conditionnement_id").val(id);
                        $("#conditionnement_code").val(codeAt);
                        $("#conditionnement_qte").val(qte);
                    });
                    return "<div class='dropdown'><button class='btn btn-secondary dropdown-toggle' type='button' id='dropdownMenuButton' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'> Plus d'option</button><div class='dropdown-menu' aria-labelledby='dropdownMenuButton'><a class='dropdown-item text-center modif' data-code='"+code+"' data-id='"+id1+"'data-qte='"+qteC+"' data-libelle='"+libel+"' href='#'>Modifier</a><a class='divider suppr' href='#'></a><a class='dropdown-item text-center btn btn-danger suppr' data-id='"+ id1 +"'  href='#' >Supprimer</a>"
                            +"</div>"+
                        "</div>";
                }
                },
        ],
        });
   
    }

    recharge()


    $("#reset").click(function(){
        vidage();
    });
    $("form").submit(function(e){
        $("#soum").addClass("spinner spinner-white spinner-right");
        e.preventDefault();
        let libelle = JSON.stringify( $("#conditionnement_libelle").val());
        let qte = JSON.stringify( $("#conditionnement_qte").val());
        let code =  JSON.stringify( $("#conditionnement_code").val());
        let id =  JSON.stringify( $("#conditionnement_id").val());
        //console.log(code,libelle);
        $.ajax({
            url: "{{path('app_conditionnement_new')}}",
            method: "POST",
            data:{ id:id, code:code, libelle:libelle, qte:qte },
            dataType: "json"
            })
            .done(function( data ) {
                recharge()
                if(data[0] == "Ajout"){
                    if ( data[1]  == "Enregistrement effectué") {
                       vidage();
                        Swal.fire(data[1], "Cliquez ici", "success");

                    }else{
                        Swal.fire(data[1], "Cliquez ici", "error");
                    }
                }else{
                    if ( data[1]  == "Modification effectuée") {
                        vidage();
                        Swal.fire(data[1], "Cliquez ici", "success");

                    }else{
                        Swal.fire(data[1], "Cliquez ici", "error");
                    }
                }
                $("#soum").removeClass("spinner spinner-white spinner-right");
                
            })
            .fail(function(data){
                //console.log(data)
                Swal.fire(data, "Cliquez ici", "error");
            });
    });

    
</script>
{% endblock %}
